<!-- This is definitely the worst code I have ever written.. but it works >_< -->
<html>
<head>
<title>webinos: File API</title>
<script type="text/javascript" src="/client/async.min.js"></script>
<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript" src="/client/jsrender.js"></script>
<script type="text/javascript" src="/webinos.utils.js"></script>
<script type="text/javascript" src="/rpc.js"></script>
<script type="text/javascript" src="/client/webinos.js"></script>
<script type="text/javascript" src="/client/webinos.file.js"></script>
<script type="text/javascript" src="/messagehandler.js"></script>
<script>
	var init = function () {
		var id = Math.floor(Math.random()*1001);
		$('button#init').attr('disabled', 'disabled');
		var address = $('#pzh_pzp_list').val();
		webinos.ServiceDiscovery.findServices(address, new ServiceType("http://webinos.org/api/file"), {
			onFound: function (service) {
				service.bind(function () {
					service.requestFileSystem(webinos.file.LocalFileSystem.PERSISTENT, 1024, function (filesystem) {
						async.series([
							function (callback) {
								load(filesystem.root, 'table#left', callback);
							}, function (callback) {
								load(filesystem.root, 'table#right', callback);
							}
						]);
					}, function (error) {
						alert("Error requesting filesystem (#" + error.code + ")");
					}, webinos.getSessionId(), id);
				});
			}
		});
	}
	
	var load = function (directory, table, superCallback) {
		$(table).data('directory', directory);

		$(table).find('caption').text(directory.fullPath);
		$(table).find('tbody').empty();
		
		async.series([
			function (callback) {
				loadParent(directory, table, callback);
			}, function (callback) {
				loadChildren(directory, table, callback);
			}
		], function (error, results) {
			webinos.utils.callback(superCallback)();
		});
	}
	
	var loadParent = function (directory, table, superCallback) {
		directory.getParent(function (parent) {
			$(table).find('tbody').prepend(renderParent(parent, table));
			
			webinos.utils.callback(superCallback)();
		}, function (error) {
			alert("Error retrieving parent (#" + error.code + ")");
			
			webinos.utils.callback(superCallback)();
		});
	}
	
	var loadChildren = function (directory, table, superCallback) {
		var reader = directory.createReader();
		
		var successCallback = function (entries) {
			entries.forEach(function (entry) {
				if (entry.isDirectory)
					var renderFun = renderDirectory;
				else if (entry.isFile)
					var renderFun = renderFile;

				var row = renderFun(entry, table);
				
				row.data('entry', entry);
				
				$(table).find('tbody').append(row);
			});
			
			if (entries.length > 0)
				reader.readEntries(successCallback, errorCallback);
			else
				webinos.utils.callback(superCallback)();
		};

		var errorCallback = function (error) {
			alert("Error reading directory (#" + error.code + ")");
			
			webinos.utils.callback(superCallback)();
		};

		reader.readEntries(successCallback, errorCallback);
	}
	
	var renderCaption = function (directory, table) {
		var caption = $($.render('caption', {
			pwd: directory.fullPath
		}));

		caption.click(function (event) {
			load(directory, table);
			
			return false;
		});
		
		return caption;
	}
	
	var renderParent = function (parent, table) {
		var row = $($.render('parent', {
			name: '..'
		}));
		
		row.find('a.link').click(function (event) {
			load(parent, table);
			
			return false;
		});
		
		return row;
	}
	
	var renderDirectory = function (directory, table) {
		var row = $($.render('directory', {
			name: directory.name
		}));
		
		var link = row.find('a.link');
		
		link.click(function (event) {
			load(directory, table);
			
			return false;
		});
		
		link.draggable({
			helper: 'clone',
			opacity: 0.5,
			revert: true,
			revertDuration: 0,
			scope: (table == 'table#left' ? 'left' : 'right')
		});
		
		row.find('button.remove').click(function (event) {
			directory.removeRecursively(function () {
				row.remove();
			}, function (error) {
				alert("Error (recursively) removing directory (#" + error.code + ")");
			});
			
			return false;
		});
		
		return row;
	}
	
	var renderFile = function (file, table) {
		var row = $($.render('file', {
			name: file.name
		}));
		
		var link = row.find('a.link');
		
		link.click(function (event) {
			var entry = file;
			
			$('div#dialog-edit').dialog({
				buttons: {
					'Save': function () {
						entry.createWriter(function (writer) {
							var bb = new webinos.file.BlobBuilder();

							bb.append($('textarea#content').val());
				
							writer.onerror = function (evt) {
								$('div#dialog-edit').dialog('close');
								$('textarea#content').val('');
								
								alert("Error writing file (#" + evt.targer.error.code + ")");
							}
							
							writer.onwrite = function (evt) {
								if (evt.target.length == 0)
									evt.target.write(bb.getBlob());
								else {
									$('div#dialog-edit').dialog('close');
									$('textarea#content').val('');
								}
							}
							
							writer.truncate(0);
						}, function (error) {
							$('div#dialog-edit').dialog('close');
							$('textarea#content').val('');
							
							alert("Error retrieving file writer (#" + error.code + ")");
						});
					},
					'Cancel': function () {
						$('div#dialog-edit').dialog('close');
						$('textarea#content').val('');
					}
				},
				modal: true,
				title: 'Editor',
				open: function () {
					entry.file(function (file) {
						var reader = new webinos.file.FileReader(entry.filesystem);
						
						reader.onerror = function (evt) {
							$(this).dialog('close');
							$('textarea#content').val('');
							
							alert("Error reading file (#" + evt.targer.error.code + ")");
						}
						
						reader.onload = function (evt) {
							$('textarea#content').val(evt.target.result);
						}
						
						reader.readAsText(file);
					}, function (error) {
						alert("Error retrieving file (#" + error.code + ")");
					});
				}
			});
			
			return false;
		});
		
		link.draggable({
			helper: 'clone',
			opacity: 0.5,
			revert: true,
			revertDuration: 0,
			scope: (table == 'table#left' ? 'left' : 'right')
		});
		
		row.find('button.remove').click(function (event) {
			file.remove(function () {
				row.remove();
			}, function (error) {
				alert("Error removing file (#" + error.code + ")");
			});
			
			return false;
		});
		
		return row;
	}
	
	$(document).ready(function () {
		$('button#init').click(init);
		
		$('table#left button.createDirectory').click(function (event) {
			var parent = $('table#left').data('directory');
			
			$('div#dialog-create').dialog({
				buttons: {
					'Ok': function () {
						parent.getDirectory($('input#name').val(), {
							create: true,
							exclusive: true
						}, webinos.utils.bind(function (entry) {
							$(this).dialog('close');
							$('input#name').val('');
							
							load($('table#left').data('directory'), 'table#left');
						}, this), webinos.utils.bind(function (error) {
							$(this).dialog('close');
							$('input#name').val('');
							
							alert("Error creating directory (#" + error.code + ")");
						}, this));
					},
					'Cancel': function () {
						$(this).dialog('close');
					}
				},
				modal: true,
				title: 'Please enter a name'
			})
		});
		
		$('table#left button.createFile').click(function (event) {
			var parent = $('table#left').data('directory');
			
			$('div#dialog-create').dialog({
				buttons: {
					'Ok': function () {
						parent.getFile($('input#name').val(), {
							create: true,
							exclusive: true
						}, webinos.utils.bind(function (entry) {
							$(this).dialog('close');
							$('input#name').val('');
							
							load($('table#left').data('directory'), 'table#left');
						}, this), webinos.utils.bind(function (error) {
							$(this).dialog('close');
							$('input#name').val('');
							
							alert("Error creating file (#" + error.code + ")");
						}, this));
					},
					'Cancel': function () {
						$(this).dialog('close');
					}
				},
				modal: true,
				title: 'Please enter a name'
			})
		});
		
		$('table#right button.createDirectory').click(function (event) {
			var parent = $('table#right').data('directory');
			
			$('div#dialog-create').dialog({
				buttons: {
					'Ok': function () {
						parent.getDirectory($('input#name').val(), {
							create: true,
							exclusive: true
						}, webinos.utils.bind(function (entry) {
							$(this).dialog('close');
							$('input#name').val('');
							
							load($('table#right').data('directory'), 'table#right');
						}, this), webinos.utils.bind(function (error) {
							$(this).dialog('close');
							$('input#name').val('');
							
							alert("Error creating directory (#" + error.code + ")");
						}, this));
					},
					'Cancel': function () {
						$(this).dialog('close');
					}
				},
				modal: true,
				title: 'Please enter a name'
			})
		});
		
		$('table#right button.createFile').click(function (event) {
			var parent = $('table#right').data('directory');
			
			$('div#dialog-create').dialog({
				buttons: {
					'Ok': function () {
						parent.getFile($('input#name').val(), {
							create: true,
							exclusive: true
						}, webinos.utils.bind(function (entry) {
							$(this).dialog('close');
							$('input#name').val('');
							
							load($('table#right').data('directory'), 'table#right');
						}, this), webinos.utils.bind(function (error) {
							$(this).dialog('close');
							$('input#name').val('');
							
							alert("Error creating file (#" + error.code + ")");
						}, this));
					},
					'Cancel': function () {
						$(this).dialog('close');
					}
				},
				modal: true,
				title: 'Please enter a name'
			})
		});
		
		$('table#left button.reload').click(function (event) {
			load($('table#left').data('directory'), 'table#left');
		});
		
		$('table#right button.reload').click(function (event) {
			load($('table#right').data('directory'), 'table#right');
		});
		
		$('table#left').droppable({
			activeClass: 'ui-state-active',
			scope: 'right',
			tolerance: 'pointer',
			drop: function (event, ui) {
				var parent = $('table#left').data('directory');
				var entry = ui.draggable.parents('tr').data('entry');
				
				if (!event.altKey)
					var fun = webinos.utils.bind(entry.copyTo, entry);
				else
					var fun = webinos.utils.bind(entry.moveTo, entry);
				
				async.series([
					function (callback) {
						fun(parent, undefined, function (entry) {
							callback();
						}, function (error) {
							alert("Error copying/moving entry (#" + error.code + ")");
						});
					}, function (callback) {
						load($('table#left').data('directory'), 'table#left', callback);
					}, function (callback) {
						load($('table#right').data('directory'), 'table#right', callback);
					}
				]);
			}
		});
		
		$('table#right').droppable({
			activeClass: 'ui-state-active',
			scope: 'left',
			tolerance: 'pointer',
			drop: function (event, ui) {
				var parent = $('table#right').data('directory');
				var entry = ui.draggable.parents('tr').data('entry');
				
				if (!event.altKey)
					var fun = webinos.utils.bind(entry.copyTo, entry);
				else
					var fun = webinos.utils.bind(entry.moveTo, entry);
				
				async.series([
					function (callback) {
						fun(parent, null, function (entry) {
							callback();
						}, function (error) {
							alert("Error copying/moving entry (#" + error.code + ")");
						});
					}, function (callback) {
						load($('table#left').data('directory'), 'table#left', callback);
					}, function (callback) {
						load($('table#right').data('directory'), 'table#right', callback);
					}
				]);
			}
		});

		$('#parent').template('parent');
		$('#directory').template('directory');
		$('#file').template('file');
	});
</script>
<link type="text/css"
	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css"
	rel="stylesheet" />
<style type="text/css">
table#left {
	width: 50%;
	float: left;
}

table#right {
	width: 50%;
	float: right;
}

div#dialog-create, div#dialog-edit {
	display: none;
}

.link {
	text-decoration: underline;
	color: #0000ff;
	cursor: pointer
}
</style>
<script id="parent" type="text/x-jquery-tmpl">
			<tr class="parent">
				<td class="type">Parent</td>
				<td class="name"><a class="link">{{=name}}</a></td>
				<td class="actions"></td>
			</tr>
</script>
<script id="directory" type="text/x-jquery-tmpl">
			<tr class="child directory">
				<td class="type">Directory</td>
				<td class="name"><a class="link">{{=name}}</a></td>
				<td class="actions"><button type="button" class="remove">Remove (recursively)</button></td>
			</tr>
</script>
<script id="file" type="text/x-jquery-tmpl">
			<tr class="child file">
				<td class="type">File</td>
				<td class="name"><a class="link">{{=name}}</a></td>
				<td class="actions"><button type="button" class="remove">Remove</button></td>
			</tr>
</script>
</head>
<body>
	<h1>webinos: File API</h1>
	<p>This demo supports directory navigation, file modification,
		entry copying (Drag &amp; Drop), entry moving (ALT + Drag &amp; Drop) and
		entry removal.</p>
	<div> PZH PZP LIST : <select id="pzh_pzp_list"> <option> </option> </select> <br> </div>
	<div><button type="button" id="init">Initialize</button></div>
	<table id="left">
		<caption></caption>
		<colgroup>
			<col width="25%"/>
			<col width="50%"/>
			<col width="25%"/>
		</colgroup>
		<thead>
			<tr>
				<th>Type</th>
				<th>Name</th>
				<th>Action(s)</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
		<tfoot>
			<tr>
				<td colspan="3">
					<button type="button" class="createDirectory">Create directory</button>
					<button type="button" class="createFile">Create file</button>
					<button type="button" class="reload">Reload</button>
				</td>
			</tr>
		</tfoot>
	</table>
	<table id="right">
		<caption></caption>
		<colgroup>
			<col width="25%"/>
			<col width="50%"/>
			<col width="25%"/>
		</colgroup>
		<thead>
			<tr>
				<th>Type</th>
				<th>Name</th>
				<th>Action(s)</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
				<tfoot>
			<tr>
				<td colspan="3">
					<button type="button" class="createDirectory">Create directory</button>
					<button type="button" class="createFile">Create file</button>
					<button type="button" class="reload">Reload</button>
				</td>
			</tr>
		</tfoot>
	</table>
	<div id="dialog-create"><input type="text" id="name"/></div>
	<div id="dialog-edit"><textarea id="content"></textarea></div>
</body>
</html>
