<!DOCTYPE html>
<html>
  <head>
    <script src="jquery-1.6.4.min.js"></script>
    <script type="text/javascript" src="../rpc.js"></script>
	<script type="text/javascript" src="webinos.js"></script>
	<script type="text/javascript" src="/messaging.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" media="screen"/>
    <script>
        jQuery(window).ready(function(){
            jQuery("#btnInit").click(initiate_geolocation);
            jQuery("#btnWatch").click(initiate_watch);  
            jQuery("#btnClear").click(clear_watch); 
            jQuery("#btnFind").click(bindservice); 
        });

		var geoLocationService = null;
		var watchId = null;
	
		function bindservice() {
		    // bind geolocation rpc service
			var address = $('#pzh_pzp_list').val();
		    webinos.ServiceDiscovery.findServices(address, new ServiceType('http://www.w3.org/ns/api-perms/geolocation'), {onFound: function (service) {
		    	geoLocationService = service;
		    	document.getElementById('position').innerHTML = "Geolocation rpc service found";   	
		    }});	    
		}
	
        function initiate_geolocation() {       	
        	var PositionOptions = {};
         	if (document.getElementById('acc_high').checked) PositionOptions.enableHighAccuracy = true;
         	PositionOptions.maximumAge = document.getElementById('freshness').value
         	PositionOptions.timeout = document.getElementById('timeout').value
        	
        	document.getElementById('debug').innerHTML = JSON.stringify(PositionOptions); // for debug

           	if ($("input[@name='locmethod']:checked").val() == 'webinos') {    
	        	if (geoLocationService)	{
    	       		geoLocationService.getCurrentPosition(handle_geolocation_query, handle_errors, PositionOptions); // webinos rpc geolocation:
        	   	}             	
            }
            else 	if ($("input[@name='locmethod']:checked").val() == 'html5') {    
	            navigator.geolocation.getCurrentPosition(handle_geolocation_query, handle_errors, PositionOptions); // HTML5 client side geolocation                      
            }
		}
	
        function handle_errors(error)
        {
            switch(error.code)
            {
                case error.PERMISSION_DENIED: alert("user did not share geolocation data");
                break;

                case error.POSITION_UNAVAILABLE: alert("could not detect current position");
                break;

                case error.TIMEOUT: alert("retrieving position timed out");
                break;

                default: alert("unknown error code = " + error.code + "; message = " + error.message);
                break;
            }
        }
 
		function handle_geolocation_query(position)
		{
		    var image_url = "http://maps.google.com/maps/api/staticmap?sensor=false&center=" + position.coords.latitude + "," +
		                    position.coords.longitude + "&zoom=14&size=400x400&markers=color:blue|label:S|" +
		                    position.coords.latitude + ',' + position.coords.longitude;
            var posdata = "<table>";
            posdata += "<tr><td>latitude</td><td>" + position.coords.latitude + "</td></tr>";	
            posdata += "<tr><td>longitude</td><td>" + position.coords.longitude + "</td></tr>";	
            posdata += "<tr><td>altitude</td><td>" + position.coords.altitude + "</td></tr>";	
            posdata += "<tr><td>accuracy</td><td>" + position.coords.accuracy + "</td></tr>";	
            posdata += "<tr><td>altitudeAccuracy</td><td>" + position.coords.altitudeAccuracy + "</td></tr>";	
            posdata += "<tr><td>heading</td><td>" + position.coords.heading + "</td></tr>";	
            posdata += "<tr><td>speed</td><td>" + position.coords.speed + "</td></tr>";	
			var d = new Date(position.timestamp); // DOMtimestamp is milliseconds since the start of the Unix Epoch
            posdata += "<tr><td>timestamp</td><td>" + d.toLocaleString() + "</td></tr>";	
            posdata += "</table>";	
			document.getElementById('position').innerHTML = posdata;
		    jQuery("#map").remove();
		    jQuery(document.body).append(
		        jQuery(document.createElement("img")).attr("src", image_url).attr('id','map')
		    );
		}        

        function initiate_watch() { 
        	var PositionOptions = {};
         	if (document.getElementById('acc_high').checked) PositionOptions.enableHighAccuracy = true;
         	PositionOptions.maximumAge = document.getElementById('freshness').value
         	PositionOptions.timeout = document.getElementById('timeout').value
        	
        	document.getElementById('debug').innerHTML = JSON.stringify(PositionOptions); // for debug
        	
        	geoLocationService.watchPosition(handle_geolocation_query, handle_errors, PositionOptions);  
 		}

        function clear_watch() { 
       		geoLocationService.clearWatch(watchId);   // webinos rpc geolocation:
		}
        
 		
		
        
    </script>
  </head>
  <body>
  	<p><div style="background-color:lightgray; border:1px solid black">
		PZH PZP LIST : <select id="pzh_pzp_list"> <option> </option> </select> <br>
  		<input type="radio" name="locmethod" value="webinos" id="loc_webinos" checked="checked">webinos RPC geolocation</input> <br>
		<input type="radio" name="locmethod" value="html5" id="loc_html5">HTML5 client-side navigator.geolocation</input>
  	</div></p>
 
  	<p><div style="background-color:lightgray; border:1px solid black">
		<input type="radio" name="acc" value="high" id="acc_high" checked="checked">enable high accuracy</input><br>
		<input type="radio" name="acc" value="any" id="acc_any">any accuracy</input><br>
		<input type="number" id="freshness" value="5000">freshness [ms]</input><br>
		<input type="number" id="timeout" value="1000">timeout [ms]</input><br>
	</div></p>

  	<p><div id="debug" style="background-color:yellow; border:1px solid red">
  		debug info
  	</div></p>
  	
    <p><div>
      <button id="btnFind" >Find Geolocation Service</button>
      <button id="btnInit" >Find my location</button>
      <button id="btnWatch" >Watch my location</button>
      <button id="btnClear" >Stop watching</button>
    </div></p>
    <p><div id="position">
  	    <script>
            document.write("undefined");
 		</script>
    </div></p>
  </body>
</html>
