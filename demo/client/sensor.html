<html>
<head>
	<title>webinos rpc</title>
	<script type="text/javascript" src="./webinos.js"></script>
	<script type="text/javascript"
		src="http://code.jquery.com/jquery-1.5.2.js"></script>
	<script type="text/javascript">

	function logObj(obj, name){
		for (var myKey in obj){
			console.log(name + "["+myKey +"] = "+obj[myKey]);
			if (typeof obj[myKey] == 'object') logObj(obj[myKey], name + "." + myKey);
		}
	}
	
            $(document).ready(function() {
                function fillPZAddrs(data) {
                	var pzhId, connectedPzh, connectedPzh;
                	if(data.from !== "virgin_pzp"){
	                    pzhId = data.payload.message.pzhId;
	                    connectedPzp = data.payload.message.connectedPzp;
                   		connectedPzh = data.payload.message.connectedPzh;
	                }
                    var pzpId = data.from;
                   
                    
                    if(document.getElementById('pzh_pzp_list'))
                        document.getElementById('pzh_pzp_list').innerHTML="";
            
                    $("<optgroup label = 'PZP' id ='pzp_list' >").appendTo("#pzh_pzp_list");
                    var i;
                    if(typeof connectedPzp !== "undefined") {
		                for(i =0; i < connectedPzp.length; i++) {
		                    $("<option value=" + connectedPzp[i] + " >" +connectedPzp[i] + "</option>").appendTo("#pzh_pzp_list");                  
		                }
		            }
                    $("<option value="+pzpId+" >" + pzpId+ "</option>").appendTo("#pzh_pzp_list");                      
                    $("</optgroup>").appendTo("#pzh_pzp_list");
                    $("<optgroup label = 'PZH' id ='pzh_list' >").appendTo("#pzh_pzp_list");
                    if(typeof connectedPzh !== "undefined") {
		                for(i =0; i < connectedPzh.length; i++) {
		                    $("<option value=" + connectedPzh[i] + " >" +connectedPzh[i] + "</option>").appendTo("#pzh_pzp_list");                  
		                }
		            }
                    $("</optgroup>").appendTo("#pzh_pzp_list");
                }
                webinos.session.addListener('registeredBrowser', fillPZAddrs);
                
                function updatePZAddrs(data) {
                    if(typeof data.payload.message.pzp !== "undefined") {
                        $("<option value=" + data.payload.message.pzp + " >" +data.payload.message.pzp + "</option>").appendTo("#pzp_list");
                    } else {
                        $("<option value=" + data.payload.message.pzh + " >" +data.payload.message.pzh + "</option>").appendTo("#pzh_list");
                    }
                }
                webinos.session.addListener('update', updatePZAddrs);
                
                function printInfo(data) {
                    $('#message').append('<li>'+data.payload.message+'</li>');
                }
                webinos.session.addListener('info', printInfo);
                
                
            	    sensors = [];
                    $('#findService').bind('click', function() {

                	    webinos.ServiceDiscovery.findServices(new ServiceType('http://webinos.org/api/sensors.temperature'), 
						{onFound: function (service) {
                	    	sensors.push(service);
                	    	$('#messages').append('<li> New Sensor found: ' + service.api + '</li>');

                	    	logObj(service, "Service");
                	    }});
                    });
                    
                    $('#cls').bind('click', function() {
                    	document.getElementById("messages").innerHTML = "";
                    }); 
                    
                    $('#bind').bind('click', function() {
                        for (var i = 0; i < sensors.length; i++){
                        	var act = i;
                        	sensors[act].bind({onBind:function(){
                        		
                        		logObj(sensors,"sensors");
                        		$('#messages').append('<li> Sensor ' + sensors[act].api + ' bound.</li>');
                    			
                    	    	$('#messages').append("<li> Max Range: " + sensors[act].maximumRange + '</li>');
                    	    	$('#messages').append("<li> Min Delay: " + sensors[act].minDelay + '</li>');
                    	    	$('#messages').append("<li> Power: " + sensors[act].power + '</li>');
                    	    	$('#messages').append("<li> Resolution: " + sensors[act].resolution + '</li>');
                    	    	$('#messages').append("<li> Vendor: " + sensors[act].vendor + '</li>');  
                    	    	$('#messages').append("<li> Version: " + sensors[act].version + '</li>'); 
                        	}});
                        }
            	    	
                    }); 
                    
                    
                    $('#configure').bind('click', function() {
                    	for (var i = 0; i < sensors.length; i++){
                    		var act = i;
                    		sensors[act].configureSensor({}, function(){
                        		$('#messages').append('<li> Sensor ' + sensors[act].api + ' configured.</li>');
                        	},
                        	function (){
                        		$('#messages').append('<li> Error configuring Sensor ' + sensors[act].api + '</li>');
                        	});
                        }
            	    	
                    });
                    
                    $('#register').bind('click', function() {
                    	for (var i = 0; i < sensors.length; i++){
                    		var act = i;
                    		sensors[act].addEventListener('temperature', 
                    				function(event){
                            			document.getElementById("sensorResult").innerHTML = "";
                        				$('#sensorResult').append('<li> Sensor Event from: ' + sensors[act].api + '</li>');
                          				$('#sensorResult').append('<li> Sensor Type: ' + event.sensorType + '</li>');
                        				$('#sensorResult').append('<li> Sensor Id: ' + event.sensorId + '</li>');
                        				$('#sensorResult').append('<li> Accuracy: ' + event.accuracy + '</li>');
                        				$('#sensorResult').append('<li> Rate: ' + event.rate + '</li>');
                        				$('#sensorResult').append('<li> Interrupt: ' + event.interrupt + '</li>');
                        				
                        				$('#sensorResult').append('<li> Absolute Temp: ' + event.sensorValues[0] + '</li>');
                        				$('#sensorResult').append('<li> Normalized Temp: ' + event.sensorValues[1] + '</li>');
                        		
                        			}
                    				, false);
                        }
                     }); 

            });
        </script>
     
</head>
<body>
	<div >
		<div >
			<p>
				<div> PZH PZP LIST : <select id="pzh_pzp_list"> <option> </option> </select> <br> </div>
				<button id="findService">Find Sensors</button>
				<button id="cls">Clear</button>
				<button id="bind">Bind Sensors</button>
		    	<button id="configure">Configure Sensors</button>
		    	<button id="register">Register for all Sensors</button>
			</p>
			<p>
				<ul id="sensorResult">
                   <br><br><br><br><br><br><br><br>
			</ul>
			</p>
		</div>
		<div >
			<ul id="messages">
			</ul>
		</div>
	</div>
</body>
</html>
