<!DOCTYPE html> 
<html>
	<head>
	<title>Player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="/client/webinosFS/js/jquery.ba-bbq.min.js"></script>
	<script type="text/javascript" src="/client/webinos.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
	<script type="text/javascript">
var $name,
	$content,
	$media;
	
var config = $.deparam.querystring();
var events = {
	service: undefined,
	handler: function (event) {
		if (event.addressing.type != "player")
			return;
		
		switch (event.type) {
			case "hello":
				var hello = events.service.createWebinosEvent("hello", {
    				type: "browser"
    			}, {
    				type: "player",
    				id: config.id,
    				name: config.name
    			});

				hello.dispatchWebinosEvent();

				break;
			case "init":
				if (event.addressing.id == config.id) {
					$name.text(event.payload.name);
					
					var extname = webinos.path.extname(event.payload.name);

					switch (extname) {
						case ".mp3":
						case ".m4a":
							$media = $('<audio src="' + event.payload.url.substring(8) + '" controls="controls"></audio>');
							break;
						case ".ogg":
						case ".m4v":
							$media = $('<video src="' + event.payload.url.substring(8) + '" controls="controls"></video>');
							break;
					}

					$content.html($media);
					
					$media.attr("autoplay", "autoplay");
					$media.on("play", function (event) {
						var play = events.service.createWebinosEvent("play", {
		    				type: "browser"
		    			}, {
		    				type: "player",
		    				id: config.id,
		    				name: config.name
		    			});

						play.dispatchWebinosEvent();
					});
					
					$media.on("pause", function (event) {
						var pause = events.service.createWebinosEvent("pause", {
		    				type: "browser"
		    			}, {
		    				type: "player",
		    				id: config.id,
		    				name: config.name
		    			});

						pause.dispatchWebinosEvent();
					});
				}
				
				break;
			case "play":
				if (event.addressing.id == config.id && typeof $media !== "undefined")
					$media.trigger("play");
				
				break;
			case "pause":
				if (event.addressing.id == config.id && typeof $media !== "undefined")
					$media.trigger("pause");
				
				break;
			case "clear":
				if (event.addressing.id == config.id)
					$content.empty();
				
				break;
		}
	}
};

webinos.session.addListener("registeredBrowser", function (event) {
	webinos.ServiceDiscovery.findServices(new ServiceType("http://webinos.org/api/events"), {
		onFound: function (service) {
			events.service = service;

    		service.bind(function () {
    			service.addWebinosEventListener(events.handler);

    			var hello = service.createWebinosEvent("hello", {
    				type: "browser"
    			}, {
    				type: "player",
    				id: config.id,
    				name: config.name
    			});

    			hello.dispatchWebinosEvent();
    		});
    	}
	});
});

$(document).ready(function () {
	$name = $("#name");
	$content = $("#content");
});
	</script>
</head>
<body>
<div data-role="page">
	<div data-role="header">
		<h1 id="name">Player</h1>
	</div>
	<div id="content" data-role="content">
	</div>
</div>
</body>
</html>
