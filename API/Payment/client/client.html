<html>
<head>
<title>webinos Payment</title>
        <script type="text/javascript" src="/rpc.js"></script>
        <script type="text/javascript" src="/client/webinos.js"></script>
        <script type="text/javascript" src="/client/webinos.payment.js"></script>
        <script type="text/javascript" src="/client/jquery-1.4.2.min.js"></script>
        
        <script type="text/javascript">

            $(document).ready(function() {
                        var myBasket = null;
                        var paymentService = null;
                        displayStatus("Initial");
                        displayError("*none*");
                        
                    $('#findService').bind('click', function() {
                            webinos.ServiceDiscovery.findServices(new ServiceType('http://webinos.org/api/payment'), {onFound: function (service) {
                                paymentService = service;   displayStatus("Service found");
                            }});                           
                    });
                    

                    $('#createShoppingBasket').bind('click', function() {

                     if (paymentService == null) { alert("Need to find service first");  }
                     else {                    
                          paymentService.createShoppingBasket(
                           function (basket) {
                                myBasket = basket;
                                displayBasketContents(myBasket);
                                displayStatus("Basket available");
                               
                            },
                            function (error) {
                                if(typeof(error)=='object')displayError(error.code+" : "+error.message);
                                else displayError("Unknown error condition");
                            },
                            "ServiceProvider123",
                            "CustomerNumber456",
                            "Shop78"
                            );      
                       }
                    }); 

                    $('#addItem').bind('click', function() {

                     if (myBasket == null) { alert("Need to create shopping basket"); }
                                       else if(myBasket.items==null){ alert("Need to create shopping basket"); }
                         
                                              else if (document.getElementById("itemList").selectedIndex == 0) {  }
                     else {
                        var tobuy= "No item";
                        if(document.getElementById("itemList").selectedIndex==1)
                           tobuy="Old Kent Road";
                        if(document.getElementById("itemList").selectedIndex==2)
                           tobuy="Euston Road";
                        if(document.getElementById("itemList").selectedIndex==3)
                           tobuy="The Strand";
                        if(document.getElementById("itemList").selectedIndex==4)
                           tobuy="Regent Street";
                        if(document.getElementById("itemList").selectedIndex==5)
                           tobuy="Mayfair";
                        if(document.getElementById("itemList").selectedIndex==6)
                           tobuy="Mornington Crescent";
                        var topay= 0;
                        if(document.getElementById("itemList").selectedIndex==1)
                           topay=60;
                        if(document.getElementById("itemList").selectedIndex==2)
                           topay=100;
                        if(document.getElementById("itemList").selectedIndex==3)
                           topay=220;
                        if(document.getElementById("itemList").selectedIndex==4)
                           topay=300;
                        if(document.getElementById("itemList").selectedIndex==5)
                           topay=400;
                        if(document.getElementById("itemList").selectedIndex==6)
                           topay=500;
                      var myItem=new ShoppingItem();
                      myItem.productID=""+document.getElementById("itemList").selectedIndex;
                      myItem.description=tobuy;
                      myItem.currency="GBP";
                      myItem.itemPrice=topay;
                      myItem.itemCount=1;
                      myItem.itemsPrice=topay;
                         myBasket.addItem(
                           function () {
                                displayBasketContents(myBasket);  
                            },
                            function (error) {
                                if(typeof(error)=='object')displayError(error.code+" : "+error.message);
                                else displayError("Unknown error condition");
                            },
                            myItem
                            );      
                         
                     }
                         
                    }); 
                    
                    $('#update').bind('click', function() {

                     if (myBasket == null) { alert("Need to create shopping basket"); }
                                       else if(myBasket.items==null){ alert("Need to create shopping basket"); }
                     else myBasket.update(
                           function () {
                                displayBasketContents(myBasket);  
                            },
                            function (error) {
                                if(typeof(error)=='object')displayError(error.code+" : "+error.message);
                                else displayError("Unknown error condition");
                            }
                            );                           
                    }); 

                    $('#checkout').bind('click', function() {

                     if (myBasket == null) { alert("Need to create shopping basket"); }
                                       else if(myBasket.items==null){ alert("Need to create shopping basket"); }
                     else myBasket.checkout(
                           function () {
                                displayBasketContents(myBasket);  
                                displayStatus("Checkout performed");
                            },
                            function (error) {
                                if(typeof(error)=='object')displayError(error.code+" : "+error.message);
                                else displayError("Unknown error condition");                          }
                            );                           
                    });       

                    $('#release').bind('click', function() {

                     if (myBasket == null) { alert("Need to create shopping basket"); }
                     else if(myBasket.items==null){ alert("Need to create shopping basket"); }
                     else {myBasket.release();  displayBasketContents(myBasket); displayStatus("Initial");   }                            
                    });     
                    
              });      
                
                function displayStatus(statusText){
                 document.getElementById("messages").innerHTML = "Status: "+statusText;
                }
                function displayError(errorText){
                 if(errorText=="*none*")
                 document.getElementById("errors").innerHTML = "Error: <FONT COLOR=\"#006600\">"+errorText+"</FONT>";
                 else
                 document.getElementById("errors").innerHTML = "Error: <FONT COLOR=\"#660000\">"+errorText+"</FONT>";
                }
                
                function displayBasketContents(myBasket){
                          if(myBasket==null){document.getElementById("shoppingBasket").value = "No basket";return;}
                          if(myBasket.items==null){document.getElementById("shoppingBasket").value = "No basket";return;}
                          var myText="Number of entries: "+myBasket.items.length;
                          for(i=0; i<myBasket.items.length;i++){
                                if(myBasket.items[i].itemCount==1)              
                                  myText=myText+"\n"+myBasket.items[i].description+ "\t"+ formattedPrice(myBasket.items[i].itemsPrice);
                            else 
                                myText=myText+"\n"+myBasket.items[i].description+ " (" +myBasket.items[i].itemCount+" for "+myBasket.items[i].itemPrice+" each)\t"+ formattedPrice(myBasket.items[i].itemsPrice);
                                }
                          if(myBasket.extras.length>0){
                                myText=myText+"\n-+-+"
                          for(i=0; i<myBasket.extras.length;i++){                               
                                myText=myText+"\n"+myBasket.extras[i].description+ "\t"+ formattedPrice(myBasket.extras[i].itemsPrice);
                                }
                                  };
                          myText=myText+"\n-+-+-+\nTotal bill: "+formattedPrice(myBasket.totalBill);
                          document.getElementById("shoppingBasket").value = myText;
                        };
              
                        
                         function formattedPrice(price){
                                resVal=""+Math.floor(price);
                                cents=Math.round((price-Math.floor(price))*100);
                                if(cents>9)resVal=resVal+"."+cents;
                                else resVal=resVal+".0"+cents;
                                return resVal;
                        }
        </script>
  
</head>
<body>
   
                        <p>
                        <button id="findService">Find Service</button><br />
                        <button id="createShoppingBasket">Create Shopping  Basket</button><br />
                        <select id="itemList" name="itemList" size=1>
                          <option value="">Select item to add to basket
                          <option value="item1">Old Kent Road - &pound;60
                          <option value="item2">Euston Road - &pound;100
                          <option value="item3">The Strand - &pound;220
                          <option value="item4">Regent Street - &pound;300
                          <option value="item5">Mayfair - &pound;400
                          <option value="item6">Mornington Crescent - &pound;500
                        </select>
                        <button id="addItem">Add Item</button><br />
                        <button id="update">Update</button><br />
                        <button id="checkout">Check-out</button><br />
                        <button id="release">Release shopping basket</button><br />
                
                       
                                <label for="shoppingBasket">Current Shopping Basket</label> 
                                <br>
                                <textarea rows='10' cols='70'
                                        id="shoppingBasket">
                                        </textarea>
                        </p>
                </div>
                <div id="messages"></div>
                <div id="errors"></div>
        </div>
</body>
</html>
