<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="copyright" content="Copyright &copy; 2011 W3C" />
<title>Test page for Webinos discovery demo</title>
<script type="text/javascript">
var webinos =
{
  on_start: function ()
  {
    this.create_plugin();
    setTimeout(function () { webinos.scan(); }, 0);
  },

  create_plugin: function ()
  {
    var embed = document.createElement("embed");
    embed.setAttribute("id", "plugin");
    embed.setAttribute("width", "0");
    embed.setAttribute("height", "0");
    embed.setAttribute("type", "application/x-webinos-plugin");
    document.body.appendChild(embed);
  },

  clear: function ()
  {
    document.getElementById("mdns").innerHTML = "";
    document.getElementById("ssdp").innerHTML = "";
    document.getElementById("slp").innerHTML = "";
    document.getElementById("bluetooth").innerHTML = "";
    document.getElementById("usb").innerHTML = "";
  },

  scan: function ()
  {
    this.clear();
    plugin = document.getElementById("plugin");

    plugin.scan_mdns(this);
    plugin.scan_ssdp(this);
    plugin.scan_slp(this);
    plugin.scan_bluetooth(this);
    plugin.scan_usb(this);
  },

  mdns: function (name, type, iface, address, port)
  {
    var status = document.getElementById("mdns");
    status.innerHTML += type + ": " + name + ", " + iface + ": " + address + ":" + port +"\n"; 
  },

  slp: function (description)
  {
    var status = document.getElementById("slp");
    status.innerHTML += description +"\n"; 
  },

  ssdp: function (address, port, description)
  {
    var i, j, type, name, desc;

    var parser = new DOMParser();
    var doc = parser.parseFromString(description, "text/xml");

    if (!doc)
      alert("couldn't parse xml: \n" +description);

    var status = document.getElementById("ssdp");

    var devices = doc.getElementsByTagName("device");

    //for (i = 0; i < devices.length; ++i)
    i = 0;
    {
      // extract interesting part of URN
      type = this.child_element(devices[i], "deviceType");

      j = type.indexOf("device");

      if (j > 0) type = type.substr(j+7);

      j = type.indexOf(":");

      if (j > 0) type = type.substr(0, j+1);

      name = this.child_element(devices[i], "friendlyName");
      //desc = this.child_element(devices[i], "modelDescription");
      status.innerHTML += type + " " + name + ", " + address + ":" + port +"\n"; 
    }
  },

  // takes several seconds before returning any results
  bluetooth: function (address, name, devclass)
  {
    var status = document.getElementById("bluetooth");
    status.innerHTML += name + ", " + address + " " + this.blue_type(devclass) +"\n"; 
  },

  usb: function (address, devclass, description)
  {
    var status = document.getElementById("usb");
    status.innerHTML += address + " " + devclass + " " + description +"\n"; 
  },


// see https://www.bluetooth.org/Technical/AssignedNumbers/baseband.htm

  blue_type: function (code)
  {
    var s = "";

    if (code & (1 << 16))
      s += "location, ";

    if (code & (1 << 17))
      s += "network, ";

    if (code & (1 << 18))
      s += "render, ";

    if (code & (1 << 19))
      s += "capture, ";

    if (code & (1 << 20))
      s += "object transfer, ";

    if (code & (1 << 21))
      s += "audio, ";

    if (code & (1 << 22))
      s += "telephony, ";

    if (code & (1 << 23))
      s += "server, ";

    var mdc = (code >> 8 ) & 63;

    if (mdc == 0)
      s += "misc";
    else if (mdc == 1)
    {
      s+= "computer, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "desktop";
      else if (mdc == 2)
        s += "server";
      else if (mdc == 3)
        s += "laptop";
      else if (mdc == 4)
        s += "handheld";
      else if (mdc == 5)
        s += "palm-sized";
      else if (mdc == 6)
        s += "watch-sized";
    }
    else if (mdc == 2)
    {
      s += "phone, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "cellular";
      else if (mdc == 2)
        s += "cordless";
      else if (mdc == 3)
        s += "smart";
      else if (mdc == 4)
        s += "wired modem or voice gateway";
      else if (mdc == 5)
        s += "common ISDN access";
    }
    else if (mdc == 3)
    {
      s+= "network access point";
    }
    else if (mdc == 4)
    {
      s+= "audio/video, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "wearable headset";
      else if (mdc == 2)
        s += "hands-free";
      else if (mdc == 4)
        s += "microphone";
      else if (mdc == 5)
        s += "loudspeaker";
      else if (mdc == 6)
        s += "headphones";
      else if (mdc == 7)
        s += "portable audio";
      else if (mdc == 8)
        s += "car audio";
      else if (mdc == 9)
        s += "set-top box";
      else if (mdc == 10)
        s += "HiFi audio";
      else if (mdc == 11)
        s += "VCR";
      else if (mdc == 12)
        s += "video camera";
      else if (mdc == 13)
        s += "camcorder";
      else if (mdc == 14)
        s += "video monitor";
      else if (mdc == 15)
        s += "video display and loudspeaker";
      else if (mdc == 16)
        s += "video conferencing";
      else if (mdc == 18)
        s += "gaming/toy";
    }
    else if (mdc == 5)
    {
      s+= "peripheral, ";
      mdc (code >> 2) & 63;

      if ((mdc >> 4) == 1)
        s += "keyboard, ";
      
      if ((mdc >> 4) == 2)
        s += "pointing device, ";

      if ((mdc >> 4) == 3)
        s += "combo keyboard/pointing device, ";

      mdc &= 15;

      if (mdc == 1)
        s += "joystick"
      else if (mdc == 2)
        s += "gamepad"; 
      else if (mdc == 3)
        s += "remote control"; 
      else if (mdc == 4)
        s += "sensing device"; 
      else if (mdc == 5)
        s += "digitizer tablet"; 
      else if (mdc == 6)
        s += "card reader"; 
    }
    else if (mdc == 6)
    {
      s += "imaging, ";

      if (code & (1 << 4))
        s += "display,";

      if (code & (1 << 5))
        s += "camera,";

      if (code & (1 << 6))
        s += "scanner,";

      if (mdc & (1 << 7))
        s += "printer,";
    }
    else if (mdc == 7)
    {
      s+= "wearable, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "wrist watch"
      else if (mdc == 2)
        s += "pager"; 
      else if (mdc == 3)
        s += "jacket"; 
      else if (mdc == 4)
        s += "helmet"; 
      else if (mdc == 5)
        s += "glasses"; 
    }
    else if (mdc == 8)
    {
      s+= "toy, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "robot"
      else if (mdc == 2)
        s += "vehicle"; 
      else if (mdc == 3)
        s += "doll or action figure"; 
      else if (mdc == 4)
        s += "controller"; 
      else if (mdc == 5)
        s += "game"; 
    }
    else if (mdc == 9)
    {
      s+= "health, ";
      mdc = (code >> 2) & 63;

      if (mdc == 1)
        s += "blood pressure monitor"
      else if (mdc == 2)
        s += "thermometer"; 
      else if (mdc == 3)
        s += "weighing scale"; 
      else if (mdc == 4)
        s += "glucose meter"; 
      else if (mdc == 5)
        s += "pulse oximeter"; 
      else if (mdc == 6)
        s += "heart/pulse rate monitor"; 
      else if (mdc == 7)
        s += "health data display"; 
      else if (mdc == 8)
        s += "step counter"; 
    }

    return s;
  },

  child_element: function (parent, tag)
  {
    var child = parent.firstChild;

    while (child)
    {
      if (child.nodeType == 1 && child.nodeName == tag)
        return child.firstChild.nodeValue;

      child = child.nextSibling;
    }

    return "unknown device";
  }
};

window.addEventListener("load", function() { webinos.on_start(); }, false); 
</script>
<style type="text/css">
  pre { padding-left: 2em }
</style>
</head>
<body>
<h1>Test page for Webinos discovery demo</h1>

<p>The following services were found with multicast DNS:</p>

<pre id="mdns"></pre>

<p>The following services were found with SSDP (UPnP):</p>

<pre id="ssdp"></pre>

<p>The following services were found with SLP:</p>

<pre id="slp"></pre>

<p>The following services were found with Bluetooth:</p>

<pre id="bluetooth"></pre>

<p>The following services were found with USB:</p>

<pre id="usb"></pre>

</body>
</html>
