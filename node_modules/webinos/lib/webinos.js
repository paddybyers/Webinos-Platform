(function () {
	var path = require("path");
	
	var webinos = function (dirname, dependencies) {
		if (typeof dependencies === "undefined")
			dependencies = webinos.resolve(dirname, "dependencies.json");
		else
			dependencies = path.resolve(dirname, dependencies);
		
		this.local = require(dependencies);
		this.local.__dirname = path.dirname(dependencies);
		this.local.require = function (location, relative) {
			return require(path.join(this.__dirname, location, relative));
		};
		
		if (typeof this.local.root !== "undefined") {
			var __dirname = path.join(this.local.__dirname, this.local.root.location);
			
			this.global = require(path.join(__dirname, "dependencies.json"));
			this.global.__dirname = __dirname;
			this.global.require = function (location, relative) {
				return require(path.join(this.__dirname, location, relative));
			};
		}
	}
	
	webinos.resolve = function (dirname, basename) {
		while (!path.existsSync(path.join(dirname, basename))) {
			var parent = path.dirname(dirname);
			
			if (parent == dirname)
				throw "Cannot find '" + basename + "'";
			
			dirname = parent;
		}
		
		return path.join(dirname, basename);
	}
	
	module.exports = function (dirname, dependencies) {
		return new webinos(dirname, dependencies);
	};
})();