<!--
/*******************************************************************************
 * Copyright 2011 Istituto Superiore Mario Boella (ISMB)
 *  
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *  
 *     http://www.apache.org/licenses/LICENSE-2.0
 *  
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/

-->
<!DOCTYPE html>
<html>
<head>

<script type="text/javascript" src="/client/jquery-1.6.4.min.js"></script>

<script type="text/javascript" src="/rpc.js"></script>
<script type="text/javascript" src="/client/webinos.js"></script>
<script type="text/javascript" src="/client/contacts/contacts.js"></script>
<script type="text/javascript"
  src="http://code.jquery.com/jquery-1.5.2.js"></script>
<script type="text/javascript"
  src="http://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dojo/dojo.xd.js"></script>
<!-- Following script contains all the client interface machinery in JS -->
<!-- <script src="./contactsClientScript.js"></script> -->
<script type="text/javascript">
  jQuery(window).ready(function()
  {
    jQuery("#btnAuthenticate").click(authenticate_cb);
    jQuery("#btnContacts").click(get_contact_list_cb);
    jQuery("#btnFindContacts").click(find_contacts_cb);
    jQuery("#btnFind").click(bindservice);
  });

  var contactsService = null;

  // Same as "FindService" button,but automatic
  function bindservice()
  {
    webinos.ServiceDiscovery
      .findServices(
        new ServiceType('http://www.w3.org/ns/api-perms/contacts'),
        {
          onFound : function(service)
          {
            contactsService = service;
            document.getElementById('html_contacts').innerHTML = "<i><b>Contacts</b></i> webinos rpc service found!<br>Please select contacts type, fill the text areas then press <i>Authenticate</i> button above.";
          }
        });

  }

  function authenticate_cb()
  {
    if (contactsService)
    {
      parameters = {};
      if ($("input[@name='contactType']:checked").val() == 'remote')
      {
        usr = $('#usernameText').val();
        pwd = $('#passwordText').val();
        parameters.usr = usr;
        parameters.pwd = pwd;
        parameters.type = "remote";

      }
      else if ($("input[@name='contactType']:checked").val() == 'local')
      {
        addressBookName = $('#addressBookNameText').val();
        parameters.addressBookName = addressBookName;
        parameters.type = "local";
      }
      contactsService.authenticate(parameters, handle_authentication_query)

    }
    else
    {
      document.getElementById('html_contacts').innerHTML = "PROBLEM: Service unreachable";
    }
  }

  function get_contact_list_cb()
  {
    parameters = {};
    var result = false;
    if (contactsService)
    {
      if ($("input[@name='contactType']:checked").val() == 'remote')
      {
        parameters.type = "remote";
        contactsService.isAlreadyAuthenticated(parameters, function(result)
        {
          contactsService.getAllContacts(parameters, print_contact_list);
        });
      }
      else if ($("input[@name='contactType']:checked").val() == 'local')
      {
        parameters.type = "local";
        contactsService.isAlreadyAuthenticated(parameters, function(result)
        {
          contactsService.getAllContacts(parameters, print_contact_list);
        });
      }
    }
  }

  function find_contacts_cb()
  {
    parameters = {};
    var result = false;
    if (contactsService)
    {
      if ($("input[@name='contactType']:checked").val() == 'remote')
      {
        parameters.type = "remote";
        //TODO set parameters.fields!!!!
        parameters.fields = {};
        if ($('#findContactName').val() != "")
          parameters.fields["name"] = $('#findContactName').val();
        if ($('#findContactEmail').val() != "")
          parameters.fields["emails"] = $('#findContactEmail').val();
        if ($('#findContactAddress').val() != "")
          parameters.fields["addresses"] = $('#findContactAddress').val();
        if ($('#findContactPhone').val() != "")
          parameters.fields["phoneNumbers"] = $('#findContactPhone').val();
        contactsService.isAlreadyAuthenticated(parameters, function(result)
        {
          contactsService.find(parameters, print_contact_list);
        });
      }
      else if ($("input[@name='contactType']:checked").val() == 'local')
      {
        parameters.type = "local";
        parameters.fields = {};
        contactsService.isAlreadyAuthenticated(parameters, function(result)
        {
          contactsService.find(parameters, print_contact_list);
        });
      }
    }
  }

  function handle_authentication_query(status) // see function
  {

    if (status)
    {
      if ($("input[@name='contactType']:checked").val() == 'remote')
        document.getElementById('authStatus').innerHTML = "<font color='#00CC00'>" + "Logged in GMail" + "</font>";
      else if ($("input[@name='contactType']:checked").val() == 'local')
        document.getElementById('authStatus').innerHTML = "<font color='#AACC00'>" + "Thunderbird Address Book Open"
          + "</font>";
    }
    else
      document.getElementById('authStatus').innerHTML = "<font color='#FF0000'><b><u>" + "CANNOT" + "</u>"
        + "Authenticate: check GMail username and password or address book file name" + "</b></font>";
  }

  // Print a contact list to HTML document
  function print_contact_list(list)
  {
    //alert("contact list size " + list.length)
    //clean then write
    document.getElementById('contactList').innerHTML = "";
    if (list.length > 0)
    {
      for ( var i = 0; i < list.length; i++)
      {
        //        console.log(list[i]);
        var contactString = (list[i].displayName == "" ? "<b>Anonymous</b></br>" : "<b>Name: </b>" +
          list[i].displayName + "<br>");
        contactString += ((list[i].nickname == undefined || list[i].nickname == "") ? "" : "<b>Nickname: </b>" +
          list[i].nickname + "<br>");

        if ((list[i].emails instanceof Array) && list[i].emails.length > 0)
        {
          contactString += "<b>Emails:</b><br>";
          for ( var j = 0; j < list[i].emails.length; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].emails[j].pref ? "* " : "&nbsp;&nbsp;") +
              list[i].emails[j].type + ": <a href=\"mailto:" + list[i].emails[j].value + "\">" +
              list[i].emails[j].value + "</a><br>";
        }
        if ((list[i].addresses instanceof Array) && list[i].addresses.length > 0)
        {
          contactString += "<b>Addresses:</b><br>";
          for ( var j = 0; j < list[i].addresses.length; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].addresses[j].pref ? "* " : "&nbsp;&nbsp;") +
              (list[i].addresses[j].type == "" ? "other" : list[i].addresses[j].type) + ": " +
              list[i].addresses[j].formatted + "<br>";
        }
        if ((list[i].phoneNumbers instanceof Array) && list[i].phoneNumbers.length > 0)
        {
          contactString += "<b>Phones:</b><br>";
          for ( var j = 0; j < list[i].phoneNumbers.length; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].phoneNumbers[j].pref ? "* " : "&nbsp;&nbsp;") +
              list[i].phoneNumbers[j].type + ": " + list[i].phoneNumbers[j].value + "<br>";
        }
        if ((list[i].ims instanceof Array) && list[i].ims.length > 0)
        {
          contactString += "<b>Messengers:</b><br>";
          for ( var j = 0; j < list[i].ims.length; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].ims[j].pref ? "* " : "&nbsp;&nbsp;") + list[i].ims[j].type +
              ": " + list[i].ims[j].value + "<br>";
        }
        if ((list[i].organizations instanceof Array) && list[i].organizations.length > 0)
        {
          contactString += "<b>Organizations:</b><br>";
          for ( var j = 0; j < list[i].organizations.length && list[i].organizations[j].name != undefined; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].organizations[j].pref ? "* " : "&nbsp;&nbsp;") +
              list[i].organizations[j].type + ": " + list[i].organizations[j].name + "<br>";
        }

        if ((list[i].photos instanceof Array) && list[i].photos.length > 0)
        {
          contactString += "<b>Picture:</b><br>";
          for ( var j = 0; j < list[i].photos.length; j++)
          {
            contactString+="<img src=\"data:image/png;base64,"+list[i].photos[j].value+"\" alt=\"Red dot\"><br>";
          }
        }

        if ((list[i].urls instanceof Array) && list[i].urls.length > 0)
        {
          contactString += "<b>Websites:</b><br>";
          for ( var j = 0; j < list[i].urls.length; j++)
            contactString += "&nbsp;&nbsp;" + (list[i].urls[j].pref ? "* " : "&nbsp;&nbsp;") + list[i].urls[j].type +
              ": <a href=\"" + list[i].urls[j].value + "\">" + list[i].urls[j].value + "</a><br>";
        }

        contactString += "<br>"
        $('#contactList').append(contactString);
        $('#contactList').append("<br>");
      }
    }
    else
      $('#contactList').append("<font color='#FF0000'><b>NO CONTACTS!</b></font>");
  }
</script>


</head>
<body>
  <!--Right part of the table-->
  <table border="1" style="height: 100%; width: 100%;">
    <tr valign="top">
      <td width="50%">
        <div>
          <div>
            <p>
              <input type="radio" name="contactType" value="remote"
                id="cnt_remote" checked="checked"">Remote
              Contacts (GMail) <br> <input type="radio"
                name="contactType" value="local" id="cnt_local"">Local
              Contacts (Thunderbird) <br> <label
                for="addressBookNameText">Local Address Book: </label>
              <!-- We'd better put an "open file" form -->
              <input type="text" id="addressBookNameText" size="40"
                placeholder="<path_to_your_Thunderbird_.mab file>" />
              <!-- But it uses C:\fakepath :( ==> no way to get full path <input type="file" id="getAddressBook" accept=".mab">-->
              <br> <label for="usernameText">Username: </label> <input
                type="text" id="usernameText"
                placeholder="enter username" /> <br> <label
                for="passwordText">Password: </label> <input
                type="password" id="passwordText"
                placeholder="enter password" /> <br>
              <!--     <label for="fileContent">File Content</label> <br>
    <textarea rows='8' size=500 id="fileContent"></textarea> -->
            </p>
          </div>
          <!--   <p> -->
          <div>
            <button id="btnFind">Find Contacts Service</button>
            <button id="btnAuthenticate">Authenticate</button>
            <br>
            <button id="btnContacts">Get All Contacts List</button>
            <button id="btnFindContacts">Find Contact!</button>
          </div>
          <!--   </p> -->

          <div id="html_contacts">

            <script>
                          document.write("NO SERVICE");
                        </script>
          </div>
          <div id="authStatus">
            <script>
                          document.write("NOT YET AUTHENTICATED");
                        </script>
          </div>
          <!--           <div id="contactList">
            <script>
                          document.write("");
                        </script>

                        <div>
              <ul id="list"></ul>
            </div>
          </div>
          </div> -->
      </td>
      <!--Right part of the table-->
      <td width="50%">
        <div>
          <!--           <p id="cwd"></p>
          <ul id="ls"></ul> -->
          <div id="find_contacts">
            <p>
              <label for="findContactName">Name: </label> <input
                type="text" id="findContactName" placeholder="Name" /><br>
              <label for="findContactEmail">Email: </label> <input
                type="text" id="findContactEmail"
                placeholder="Email Address" /><br> <label
                for="findContactPhone:">Phone: </label> <input
                type="text" id="findContactPhone" placeholder="Phone" /><br>
              <label for="findContactEmail">Address: </label> <input
                type="text" id="findContactAddress"
                placeholder="Address" /><br>
            </p>
          </div>
          <div id="contactList">
            <script>
                          document.write("");
                        </script>
          </div>
        </div>

      </td>
    </tr>
  </table>
</body>
</html>
