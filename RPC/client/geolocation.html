<!DOCTYPE html>
<html>
  <head>

    <script src="jquery-1.6.4.min.js"></script>
    
    <script type="text/javascript" src="../rpc.js"></script>
	<script type="text/javascript" src="./webinos.js"></script>
	<script type="text/javascript" src="./geolocation.js"></script>
       
    
    <script>
        jQuery(window).ready(function(){
            jQuery("#btnInit").click(initiate_geolocation);
            // jQuery("#btnWatch").click(initiate_geolocation);  // dummy
            // jQuery("#btnClear").click(initiate_geolocation);  // dummy
        });

		var geoLocationService = null;
	
		function bindservice() {
		    // bind geolocation rpc service
		    webinos.ServiceDiscovery.findServices("Geolocation", {onFound: function (service) {
		    	geoLocationService = service;
		    	document.getElementById('position').innerHTML = "Geolocation rpc service found";   	
		    }});	    
		}
	
        function initiate_geolocation() { 
           	if ($("input[@name='locmethod']:checked").val() == 'webinos') {    
	        	if (geoLocationService)	{
    	       		geoLocationService.getCurrentPosition(handle_geolocation_query);   // webinos rpc geolocation:
        	   	}             	
            }
            else 	if ($("input[@name='locmethod']:checked").val() == 'html5') {    
	            navigator.geolocation.getCurrentPosition(handle_geolocation_query,handle_errors); // HTML5 client side geolocation                      
            }
		}
	
        function handle_errors(error)
        {
            switch(error.code)
            {
                case error.PERMISSION_DENIED: alert("user did not share geolocation data");
                break;

                case error.POSITION_UNAVAILABLE: alert("could not detect current position");
                break;

                case error.TIMEOUT: alert("retrieving position timed out");
                break;

                default: alert("unknown error");
                break;
            }
        }
 
		function handle_geolocation_query(position)
		{
		    var image_url = "http://maps.google.com/maps/api/staticmap?sensor=false&center=" + position.coords.latitude + "," +
		                    position.coords.longitude + "&zoom=14&size=400x400&markers=color:blue|label:S|" +
		                    position.coords.latitude + ',' + position.coords.longitude;
            var posdata = "<table>";
            posdata += "<tr><td>latitude</td><td>" + position.coords.latitude + "</td></tr>";	
            posdata += "<tr><td>longitude</td><td>" + position.coords.longitude + "</td></tr>";	
            posdata += "<tr><td>altitude</td><td>" + position.coords.altitude + "</td></tr>";	
            posdata += "<tr><td>accuracy</td><td>" + position.coords.accuracy + "</td></tr>";	
            posdata += "<tr><td>altitudeAccuracy</td><td>" + position.coords.altitudeAccuracy + "</td></tr>";	
            posdata += "<tr><td>heading</td><td>" + position.coords.heading + "</td></tr>";	
            posdata += "<tr><td>speed</td><td>" + position.coords.speed + "</td></tr>";	
			var d = new Date(position.timestamp); // DOMtimestamp is milliseconds since the start of the Unix Epoch
            posdata += "<tr><td>timestamp</td><td>" + d.toLocaleString() + "</td></tr>";	
            posdata += "</table>";	
			document.getElementById('position').innerHTML = posdata;
		    jQuery("#map").remove();
		    jQuery(document.body).append(
		        jQuery(document.createElement("img")).attr("src", image_url).attr('id','map')
		    );
		}        
        
        
    </script>
  </head>
  <body onload="bindservice();">
  	<div>
  		<input type="radio" name="locmethod" value="webinos" id="loc_webinos" checked="checked">webinos RPC geolocation</input> <br>
		<input type="radio" name="locmethod" value="html5" id="loc_html5">HTML5 client-side navigator.geolocation</input>
  	</div>
  
    <p><div>
      <button id="btnInit" >Find my location</button>
      <button id="btnWatch" >Watch my location</button>
      <button id="btnClear" >Stop watching</button>
    </div></p>
    <p><div id="position">
  	    <script>
            document.write("undefined");
 		</script>
    </div></p>
  </body>
</html>