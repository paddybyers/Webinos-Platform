<html>
<head>
	<title>webinos | vehicle testbed</title>
	<link rel="stylesheet" type="text/css" href="style.css" media="screen"/>
	<script type="text/javascript" src="/rpc.js"></script>
	<script type="text/javascript" src="/client/webinos.js"></script>
	<script type="text/javascript" src="../jquery-1.6.4.min.js"></script>
	<script type="text/javascript" src="./fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
	<script type="text/javascript" src="./fancybox/jquery.fancybox-1.3.4.pack.js"></script>
	<script type="text/javascript" src="jcanvas.min.js"></script>
	<link rel="stylesheet" type="text/css" href="./fancybox/jquery.fancybox-1.3.4.css" media="screen" />
	
		<script type="text/javascript">
			
			$(document).ready(function() {
					var vehicle = null;		
					var listeners = new Array();
					var _vehicleDataIds = new Array('climate-all', 'climate-driver', 'climate-passenger-front', 'climate-passenger-rear-left','climate-passenger-rear-right','lights-fog-front','lights-fog-rear','lights-signal-right','lights-signal-warn','lights-parking-hibeam','lights-head','lights-head','wiper-front-wash','wiper-rear-wash','wiper-automatic','wiper-front-once','wiper-rear-once','wiper-front-level1','wiper-front-level2','destination-reached','destination-changed','destination-cancelled','parksensors-front','parksensors-rear','tripcomputer', 'shift'); 
					postMessage('Info','Page loaded. Please Initialize');
					
				$("#pdcLauncher").fancybox({
				'transitionIn'		: 'fade',
				'transitionOut'		: 'fade',
				'showCloseButton'	: false
				});
					
					
					
					var handleShiftData = function(event){
						postMessage("info","new Shift-Event received.");
						$('#info').html("gear: <br />" + event.gear);
					};
					
					var handleTripData = function(data){
						postMessage("info","new TripComputer-Event received.");
						$('#info').empty();
						$('#info').append("<p>Average Consumption1: "+ data.averageConsumption1 +"</p>");
						$('#info').append("<p>Average Consumption2: "+ data.averageConsumption2 +"</p>");
						$('#info').append("<p>Average Speed1: "+ data.averageSpeed1 +"</p>");
						$('#info').append("<p>Average Speed2: "+ data.averageSpeed2 +"</p>");
						$('#info').append("<p>Trip distance: "+ data.tripDistance +"</p>");
						$('#info').append("<p>Mileage "+ data.mileage +"</p>");
						$('#info').append("<p>Range " 	+ data.range +"</p>");
						
					}
					
					
					var handleParkSensorsData = function(data){
						postMessage("info","new ParkSensorsData received for position: " + data.position);
						$('#info').empty();
						$('#info').append("<p>Position: "+ data.position +"</p>");
						$('#info').append("<p>Left: "+ data.left +"</p>");
						$('#info').append("<p>Middle Left: "+ data.midLeft +"</p>");
						$('#info').append("<p>Middle Right: "+ data.midRight +"</p>");
						$('#info').append("<p>Right: "+ data.right +"</p>");
						
					}
						
					var errorCB = function(error){
						postMessage('error', "ERROR:" + error.message);
						console.log('error' + error.message);
					};
					$('#vehicleDataId').change(function(){
						var listenerRegistered = false;
						for(i=0; i < listeners.length; i++){
							if(listeners[i] == $('#vehicleDataId').val()){
								listenerRegistered = true;
								break;	
							}	
						}
						if(listenerRegistered){
							$('#removeListener').removeAttr('disabled');
							$('#addListener').attr('disabled', 'true');	
						}else{					
							$('#addListener').removeAttr('disabled');
							$('#removeListener').attr('disabled', 'true');

						}
						
						
					});
					
					
					
					$('#getData').bind('click', function(){
						vehicle.get($('#vehicleDataId').val(), getMessageHandler($('#vehicleDataId').val()) ,errorCB);
						});
						
						
					$('#init').click(function(e) {
                           webinos.ServiceDiscovery.findServices(new ServiceType('http://webinos.org/api/vehicle'), {onFound: function (service) {
                	    	
							console.log("service found...");
							
							vehicle = service;
							postMessage("Connected Vehicle System. Please choose a function");
							$('#addListener').removeAttr('disabled');
							$('#getData').removeAttr('disabled');
							$('#startPdc').removeAttr('disabled');
							$('#vehicleDataId').removeAttr('disabled');
							//$('#requestGuidance').removeAttr('disabled');
							
							$('#info').html("<img src='ajaxloader.gif'>");
							
							$('#findService').attr('disabled', 'true');
							$('#findService').val('Vehicle found');
						
                	}});
                    });
					
					startPdc
					
					var pdcActivated = false;
					
					$('#startPdc').bind('click', function(){
						if(!pdcActivated){
							pdcActivated = true;
							vehicle.addEventListener('shift', pdcAppHandler, false);
							postMessage('info', 'Listener for PDC-App registered');
						
							$('#startPdc').val('PDC App (running)');
							$('#startPdc').addClass('running');
						}else{
							$('#startPdc').val('PDC App');
							$('#startPdc').removeClass('running');
							pdcActivated = false;
							vehicle.removeEventListener('shift', pdcAppHandler, false);
						}
					});
					
					
					
					
					
					$('#addListener').bind('click', function(){
						

						vehicle.addEventListener($('#vehicleDataId').val(), getMessageHandler($('#vehicleDataId').val()), false);
						listeners.push($('#vehicleDataId').val());
						
						$('#removeListener').removeAttr('disabled');
						$('#addListener').attr('disabled', 'true');	
						
					});
					$('#removeListener').bind('click', function(){
						vehicle.removeEventListener($('#vehicleDataId').val(), getMessageHandler($('#vehicleDataId').val()), false);
						postMessage('info','Listener removed for' + $('#vehicleDataId').val());
						$('#info').html("<img src='ajaxloader.gif'>");
						for(i = 0; listeners.length; i++){
							if(listeners[i] == $('#vehicleDataId').val()){
								listeners.splice(i,1);
								break;	
							}
					}
						$('#addListener').removeAttr('disabled');
						$('#removeListener').attr('disabled', 'true');
					});
						
					$(window).unload(function(e) {
                        for(i= 0; i < listeners.length; i++){
						console.log('Removing listener for ' + listeners[i]);
							vehicle.removeEventListener(listeners[i],getMessageHandler(listeners[i]), false);
						}
                    });
						
					function postMessage(type,message){
						var time = new Date();
						$("#message").html(message + " (" + time.toUTCString() +")");
						if(type == "error"){
							$("#status").addClass('error');
						}else{
							$("#status").removeClass('error');
						}
					}
					function getMessageHandler(vehicleDataId){
						switch(vehicleDataId){
							case "shift":
								return handleShiftData;
								break;
							case "tripcomputer":
								return handleTripData;
								break;
							case "parksensors-front":
								return handleParkSensorsData;
								break;
							case "parksensors-rear":
								return handleParkSensorsData;
								break;
							default:
								return handleShiftData;
						}						
					}
				
		
				         	    
					for(i=0; i < _vehicleDataIds.length; i++){
						$('#vehicleDataId').append(new Option(_vehicleDataIds[i],_vehicleDataIds[i],true,true));
					}				
				
				
				
				function drawPdcBase(position){
					
					if(position == "parksensors-front"){
						canvas = $('#pdcFront');
						centerX =  200;
						centerY =  75;
						start = 250;
						end = 290;
						radius = 154;
						width = 88;
						
					
					}else if(position == "parksensors-rear"){
						canvas = $('#pdcRear');
						centerX = -100;
						centerY = 75; 
						start = 70;
						end = 110;
						radius = 154;
						width = 88;
					}
									canvas.clearCanvas();
					
					canvas.drawArc({
  						strokeStyle: "#6C8080",
  						opacity: 0.4,
  						strokeWidth: width,
  						x: centerX, y: centerY,
  						radius: radius,
  						start: start, end: end
					});
					
					
				}
				
				
				function drawPdcObstacles(params){
					
					position = params.position;
					left = params.left;
					midLeft = params.midLeft;
					midRight = params.midRight;
					right = params.right;
					
					
					widthRed = 10;
					widthYellow = 14;
					widthGreen = 20;
					
					radiusGreen1 = 188;
					radiusGreen2 = 168;
					
					radiusYellow1 = 151;
					radiusYellow2 = 137;
					
					radiusRed1 = 125;
					radiusRed2 = 115;
					
					green = "#51FF19"
					yellow = "#F3FF17";
					red = "#FF3E00";
					
					
					if(position == "parksensors-front"){
						canvas = $('#pdcFront');
						centerX =  200;
						centerY =  75;
						
						//250 -- 290					
						leftStart = 250;
						leftEnd = 260;
					
						midLeftStart = 260;
						midLeftEnd = 270;
					
						midRightStart = 270;
						midRightEnd = 280;
					
						rightStart = 280;
						rightEnd = 290;

					
					
					}else if(position == "parksensors-rear"){
						canvas = $('#pdcRear');
						centerX = -100;
						centerY = 75; 

						//70 -- 110					
						leftStart = 70;
						leftEnd = 80;
					
						midLeftStart = 80;
						midLeftEnd = 90;
					
						midRightStart = 90;
						midRightEnd = 100;
					
						rightStart = 100;
						rightEnd = 110;



					}
					drawPdcBase(position);
					
					
					//250 185  120 80 40 20
					
					//GREEN  ONE
					///LEFT
					if(left < 250){
						canvas.drawArc({
							strokeStyle: green,
							strokeWidth: widthGreen,
							x: centerX, y: centerY,
							radius: radiusGreen1,
							start: leftStart, end: leftEnd
						});
					}
					///MIDLEFT
					if(midLeft < 250){
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen1,
  						start: midLeftStart, end: midLeftEnd
					});	
					}
					if(midRight < 250){
					///MIDRIGHT
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen1,
  						start: midRightStart, end: midRightEnd
					});
					}
					///RIGHT
					if(right < 250){
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen1,
  						start: rightStart, end: rightEnd
					});
					}
					//GREEN TWO
					///LEFT
					//250 185  120 80 40 20
					if(left < 185){
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen2,
  						start: leftStart, end: leftEnd
					});
					}
					///MIDLEFT
					if(midLeft < 185){
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen2,
  						start: midLeftStart, end: midLeftEnd
					});		
					}
					///MIDRIGHT
					if(midRight < 185){
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen2,
  						start: midRightStart, end: midRightEnd
					});					
					}
					///RIGHT
					if(right < 185){					
					canvas.drawArc({
  						strokeStyle: green,
  						strokeWidth: widthGreen,
  						x: centerX, y: centerY,
  						radius: radiusGreen2,
  						start: rightStart, end: rightEnd
					});
					}
					//YELLOW ONE
					///LEFT
					if(left < 120){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow1,
  						start: leftStart, end: leftEnd
					});
					}
					///MIDLEFT
					if(midLeft < 120){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow1,
  						start: midLeftStart, end: midLeftEnd
					});		
					}
					///MIDRIGHT
					if(midRight < 120){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow1,
  						start: midRightStart, end: midRightEnd
					});			
					}
					if(right < 120){
					///RIGHT
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow1,
  						start: rightStart, end: rightEnd
					});		
					}
					//YELLOW TWO
					///LEFT
					if(left < 80){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow2,
  						start: leftStart, end: leftEnd
					});
					}
					///MIDLEFT
					if(midLeft < 80){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow2,
  						start: midLeftStart, end: midLeftEnd
					});		
					}
					///MIDRIGHT
					if(midRight < 80){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow2,
  						start: midRightStart, end: midRightEnd
					});			
					}
					///RIGHT
					if(right < 80){
					canvas.drawArc({
  						strokeStyle: yellow,
  						strokeWidth: widthYellow,
  						x: centerX, y: centerY,
  						radius: radiusYellow2,
  						start: rightStart, end: rightEnd
					});	
					}
					//RED ONE
					///LEFT
					if(left < 40){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed1,
  						start: leftStart, end: leftEnd
					});
					}
					
					///MIDLEFT
					if(midLeft < 40){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed1,
  						start: midLeftStart, end: midLeftEnd
					});		
					}
					///MIDRIGHT
					if(midRight < 40){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed1,
  						start: midRightStart, end: midRightEnd
					});			
					}
					///RIGHT
					if(right < 40){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed1,
  						start: rightStart, end: rightEnd
					});		
					}
					//RED TWO
					///LEFT
					if(left < 20){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed2,
  						start: leftStart, end: leftEnd
					});
					}
					///MIDLEFT
					if(midLeft < 20){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed2,
  						start: midLeftStart, end: midLeftEnd
					});				
					}
					///MIDRIGHT
					if(midRight < 20){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed2,
  						start: midRightStart, end: midRightEnd
					});			
					}
					///RIGHT
					if(right < 20){
					canvas.drawArc({
  						strokeStyle: red,
  						strokeWidth: widthRed,
  						x: centerX, y: centerY,
  						radius: radiusRed2,
  						start: rightStart, end: rightEnd
					});		
					}
				}

		
				function pdcAppHandler(event){
					
					//Neutral 11, Parking 10; Rear 0
					if(event.gear == 0){
						
						//poping up PDC app...
						$("#pdcLauncher").trigger('click');
						
						drawPdcBase("parksensors-front");
						drawPdcBase("parksensors-rear");
						
						vehicle.addEventListener('parksensors-front',drawPdcObstacles,false);
						vehicle.addEventListener('parksensors-rear',drawPdcObstacles,false);

					}
					else if(event.gear >= 2){
						
						$.fancybox.close();
						
						vehicle.removeEventListener('parksensors-front',drawPdcObstacles,false);
						vehicle.removeEventListener('parksensors-rear',drawPdcObstacles,false);
						
						if(event.gear == 10 || event.gear == 11){
							postMessage('info', 'Vehicle parked. Disabling PDC app');
						}else{
							postMessage('info', 'Driving again. Disabling PDC app');
						}
						
					}
					
				}
			});			
			
</script>
</head>
<body>
<div id="content">
	<div id="header">
		<h1><img src="testbed_logo.png"></h1>
     </div>
     <div id="functions">
		<h2>Testfunctions:</h2>
        <!-- <h3>First Step</h3>	
        <p><input type="button" id="findService" value="initialize" class="button"/></p>  -->
		<h3>Access vehicle data</h3>
        <p>
            <input type="button" id="init" value="initialize System" class="button"/><br />
            <select id="vehicleDataId" disabled>
            </select><br/>
            <input type="button" id="getData" value="get Data" disabled class="button"/><br />
            <input type="button" id="addListener" value="add EventListener" disabled class="button"/><br>
            <input type="button" id="removeListener" value="remove EventListener" disabled class="button"/><br>
            </p>
         <h3>Navigationfunctions</h3>
			<input type="button" id="requestGuidance" value="request Guidance" disabled class="button"/>
            <input type="button" id="findDestinations" value="find POI" disabled class="button"/>
            <h3>Apps</h3>
<input type="button" id="startPdc" value="PDC App" disabled class="button"/>
<a href="#pdcApp"  id="pdcLauncher" title="Parkdistance App">Inline</a>
		</p>
    </div>
<div id="info"></div>




	<div id="status">STATUS: <span id="message">Please connect to PZH</span></div>
</div>

	<div style="display: none;">
		<div id="pdcApp" >
			<canvas id="pdcFront" width="100" height="150"></canvas>
			<canvas id="pdcRear" width="100" height="150"></canvas>
		</div>
	</div>

</body>
</html>